<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방명록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./css/vistorlog.css">

    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-firestore.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script type="module">

        const firebaseConfig = {
            apiKey: "AIzaSyAzXX5j6y95F5-w-aemZc--QymtiWT_UVM",
            authDomain: "intro-team-42d34.firebaseapp.com",
            databaseURL: "https://intro-team-42d34-default-rtdb.firebaseio.com",
            projectId: "intro-team-42d34",
            storageBucket: "intro-team-42d34.appspot.com",
            messagingSenderId: "367458824490",
            appId: "1:367458824490:web:cfeed0e953eab5a2206e53",
            measurementId: "G-Y60R200KGX"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        //방명록 불러오는 부분
        const dbRef = database.ref('logs');
        dbRef.on("value", (snapshot) => {
            snapshot.forEach((child) => {

                const object = child.val();
                let temp = `
    <div class="log">
        <div class="input-group mb-3">
            <span class="input-group-text">${object.date}</span>
            <span class="input-group-text">${object.name}</span>
            <span><input type="text" id="deleteLogPw" placeholder="Password" aria-label="Password" class="form-control"></span>
            <button class="btn btn-secondary" type="button" id="deleteLogBtn">삭제</button>
            <div class="logText" id = ${child.ref.key}>
                ${object.content}
            </div>
        </div>
    </div>
    `

                $('#logBox').append(temp)

            });
        });
        //방명록 불러오는 부분 끝남

        //방명록 등록하는 부분
        $("#logRegisterBtn").click(async function () {

            let name = $('#logName').val();
            let pw = $('#logPassword').val();
            let content = $('#logContent').val();
            const today = new Date();
            let day = today.getDate();
            let month = today.getMonth() + 1;
            let year = today.getFullYear();

            let date = `${year}-${month}-${day}`;

            let doc = {
                'name': name,
                'pw': pw,
                'content': content,
                'date': date
            }

            await database.ref('logs').push(doc);

            //메인페이지에 보이게 하기 위해 저장
            // let doc2 = {
            //     'flag':0
            // }
            // await database.ref('flags').push(doc2)

            //3개의 방명록을 메인페이지에 보여주기 위해 키 저장하기
            // let doc3 = {
            //     'key1':'',
            //     'key2':'',
            //     'key3':''
            // }
            // await database.ref('keys').push(doc3);



            //메인페이지 저장 부분 시작
            let content1 = localStorage.getItem('content1');
            let name1 = localStorage.getItem('name1');
            let content2 = localStorage.getItem('content2');
            let name2 = localStorage.getItem('name2');

            localStorage.setItem('content2', content1);
            localStorage.setItem('name2', name1);
            localStorage.setItem('content3', content2);
            localStorage.setItem('name3', name2);

            localStorage.setItem('content1', content);
            localStorage.setItem('name1', name);
            //메인페이지 저장 부분 끝

            window.location.reload();
        });
        //방명록 등록 끝



        //방명록 삭제하는 부분
        $(document).on("click", "#deleteLogBtn", function () {

            //alert("click");

            let parentDiv = $(this).closest('div');
            let textDiv = parentDiv.children('.logText');
            let pwInput = parentDiv.find('input');


            let id = textDiv.attr('id');
            let password = pwInput.val();

            const dbRef = database.ref('logs');

            dbRef.on("value", (snapshot) => {
                snapshot.forEach((child) => {
                    const object = child.val();

                    if (id == child.ref.key) {
                        if (object.pw == password) {
                            dbRef.child(id).remove();
                        }
                        else {
                            alert("잘못된 비밀번호");

                        }
                    }
                });
            });
            window.location.reload();
        });
        //방명록 삭제 끝남
    </script>
</head>

<body>
    <div class="box1" style="position:relative;">
        <div class="uppertext" style="position: absolute;">
            <p class="text1" style="display:inline">TODAY <span class="red">2002</span> | TOTAL 118</p>
            <p class="text2" style="display:inline; font-size: 30px; font-weight: 600;">I-world</p>
            <p class="text3" style="display:inline">참고: https://www.cyworld.com</p>
        </div>
        <div class="box2">
            <p class="mood" style="font-size: 15px;">TODAY is 행복🎃</p>
            <div class="myimage">

            </div>
            <div class="introduce">
                <p style="font-size: 14px;">
                    I 좋은 사람들 I 좋은 세상 <br><br>
                    내일배움캠프 <br> 3기 spring b반 3조 <br>
                    <br> I-WORLD 에 오신걸 <br> 환영합니다!
                </p>
            </div>
        </div>
        <div class="rings" style="position: absolute;">
            <div class="set1">
                <div class="ring"></div>
                <div class="ring"></div>
            </div>
            <div class="set2">
                <div class="ring"></div>
                <div class="ring"></div>
            </div>
        </div>
        <div class="box3">
            <div class="inputlogBox">
                <div class="input-group">
                    <span class="input-group-text">Name</span>
                    <input type="text" id="logName" placeholder="Name" aria-label="Name" class="form-control">
                    <span class="input-group-text">Password</span>
                    <input type="text" id="logPassword" placeholder="Password" aria-label="Password"
                        class="form-control">
                </div>

                <textarea class="form-control" id="logContent" rows="3"></textarea>

                <div>
                    <button type="button" id="logRegisterBtn" class="btn btn-secondary" style="float:right">등록</button>
                </div>

            </div>
            <div class="logBox">
                <div class="log" id="logBox">

                </div>
            </div>
        </div>
        <div class="buttons" style="position: absolute;">
            <button id="index" class="index">홈</button>
                <button id="sunghun" class="sunghun">김성훈</button>
                <button id="minsun" class="minsun">김민선</button>
                <button id="minah" class="minah">유민아</button>
                <button id="yejin" class="yejin">이예진</button>
                <button id="visitor" class="visitor">방명록</button>
        </div>
    </div>

    <script src="./db/buttonfunc.js"></script>
</body>

</html>